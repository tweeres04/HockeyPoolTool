<!DOCTYPE html>
<html>
    <head>
        <title>Hockey Pool Tool</title>
        <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
        <style type="text/css">

        </style>
    </head>
    <body>
        <div class="container" data-bind="template: 'side-template'"></div>

        <script type="text/html" id="side-template">
            <h2>Hockey Pool Tool</h2>
            <div class="row">
                <div class="col-md-3">
                    <h3>Players</h3>
                    <select class="form-control" data-bind="options: allTeams, value: selectedTeam, optionsText: 'name'"></select>
                    <ul class="list-unstyled players-list" data-bind="foreach: allPlayers">
                        <li class="player" data-bind="visible: Team == $root.selectedTeam().code, text: Name" style="cursor:move; font-size: 22px; padding:5px 15px;"></li>
                    </ul>
                </div>
                <div class="col-md-9">
                    <h3>My Team</h3>
                    <ul class="my-team list-inline well" data-bind="foreach: myTeam">
                        <li class="my-team-player col-md-4" data-bind="text: Name" style="font-size: 28px; cursor: move;"></li>
                    </ul>
                </div>
            </div>
        </script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="/knockout-2.3.0.js"></script>
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
        <script type="text/javascript">
            var ViewModel = function () {
                var me = this;

                me.allPlayers = ko.observableArray();

                me.allTeams = ko.observableArray();

                me.resizeMyTeamPanel = function () {
                    $(".my-team").height($(".players-list").height());
                };

                me.selectedTeam = ko.observable({ code: "Hi", name: "Please select a team" });
                me.selectedTeam.subscribe(function (newValue) {
                    me.resizeMyTeamPanel();
                });
                me.selectedPlayer = ko.observable("");

                me.myTeam = ko.observableArray();

                me.loadData = function (callback) {
                    $.getJSON("/teams", function (teams) {
                        me.allTeams(teams);
                        me.selectedTeam(me.allTeams()[0]);
                        $.getJSON("/players", function (players) {
                            me.allPlayers(players);
                            $.getJSON("/myteam", function (team) {
                                me.myTeam(team);

                                me.myTeam.subscribe(function (newValue) {
                                    $.post("/myteam", ko.toJSON(me.myTeam), function (response) {
                                        console.log(response);
                                    });
                                });

                                for (var i in me.myTeam()) {
                                    for(var j in me.allPlayers()){
                                        if(me.myTeam()[i].Name == me.allPlayers()[j].Name){
                                            me.allPlayers.remove(me.allPlayers()[j]);
                                            break;
                                        }
                                    }
                                }
                                callback();
                            });
                        });
                    });
                };

                me.init = function () {
                    $.ajaxSetup({ contentType: "application/json" });

                    me.loadData(afterLoadData);
                    
                    function afterLoadData() {
                        me.resizeMyTeamPanel();
                        setUpDragAndDrop();
                    }

                    function setUpDragAndDrop() {
                        $(".player, .my-team-player").draggable({ revert: true, zIndex: 10 });
                        $(".my-team").droppable({
                            accept: ".player",
                            tolerance: "pointer",
                            drop: function (event, ui) {
                                var player = ko.dataFor(ui.draggable[0]);
                                me.allPlayers.remove(player);
                                me.myTeam.push(player);
                                $(".my-team-player").draggable({ revert: true });
                            }
                        });
                        $("body").droppable({
                            accept: ".my-team-player",
                            tolerance: "pointer",
                            drop: function (event, ui) {
                                var player = ko.dataFor(ui.draggable[0]);
                                me.allPlayers.push(player);
                                me.myTeam.remove(player);
                                $(".player").draggable({ revert: true });
                            }
                        });

                        $(".my-team").on("drop", function (event, ui) {
                            event.stopPropagation();
                        });
                    }
                };

                me.init();
            };

            ko.applyBindings(new ViewModel());
        </script>
    </body>
</html>